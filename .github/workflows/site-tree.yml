# File: .github/workflows/site-tree.yml
name: Generate and Publish Site-Tree

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  build-tree:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install wget and tree
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y wget tree

      - name: Mirror live site
        run: |
          rm -rf site-mirror
          wget --mirror --quiet --convert-links --no-parent \
               https://cameronbrooks11.github.io \
               -P site-mirror

      - name: Generate markdown tree snippet
        run: |
          set -euo pipefail

          ROOT="site-mirror/cameronbrooks11.github.io"

          # Build raw tree into SITE_TREE_RAW.md
          tree -fi --noreport -L 3 "$ROOT" | \
            sed "s|$ROOT||" | sed '/^$/d' | \
            awk '{
              path=$0; sub(/\/$/,"",path)
              if (path ~ /index\.html$/) {
                link=substr(path,1,length(path)-11)
                link=(link==""?"/":link)
              } else link=path
              if (link !~ /^\//) link="/" link
              print "- [" link "](" link ")"
            }' > SITE_TREE_RAW.md

          # Clean ignore file: remove comments (#...) and blank lines
          sed 's/#.*//' .site-tree-ignore | sed '/^[[:space:]]*$/d' > IGNORE_CLEAN

          # Debug: show cleaned patterns
          echo "===== IGNORE_CLEAN ====="
          cat -n IGNORE_CLEAN

          # Filter raw tree into SITE_TREE_FILTERED.md
          grep -v -E -f IGNORE_CLEAN SITE_TREE_RAW.md > SITE_TREE_FILTERED.md

          # Debug: show filtered result
          echo "===== SITE_TREE_FILTERED.md ====="
          cat -n SITE_TREE_FILTERED.md

          # Append to index.markdown
          {
            echo ""
            echo "## Site Tree"
            cat SITE_TREE_FILTERED.md
          } >> index.markdown

      - name: Clean up temp files
        run: |
          rm -rf site-mirror SITE_TREE_SNIPPET.md

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update site tree"
          branch: "auto/site-tree-${{ github.run_number }}"
          title: "chore: update site tree"
          body: |
            This PR was automatically generated by the site-tree workflow.
          add-paths: |
            index.markdown
